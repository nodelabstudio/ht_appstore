---
phase: 04.1-fix-streak-and-day-tracking
plan: 01
subsystem: core-data-layer
tags: [bug-fix, date-handling, streak-calculation, validation]

requires:
  - 01-01: Challenge model and data storage foundation
  - 01-02: ChallengeRepository with completion tracking

provides:
  - Consistent UTC date normalization across all date operations
  - Start date validation preventing pre-challenge completions
  - Correct streak and day counter calculations
  - Duplicate prevention in calendar interactions

affects:
  - 04-02: Pre-launch polish can now proceed with correct date tracking
  - Future phases can rely on consistent date storage format

tech-stack:
  added: []
  patterns:
    - "DateTime.utc(year, month, day) for local date storage"
    - "Early return pattern for validation guards"
    - "Component-wise date comparison for duplicate detection"

key-files:
  created: []
  modified:
    - challenge_tracker/lib/core/utils/streak_calculator.dart
    - challenge_tracker/lib/features/challenges/data/repositories/challenge_repository.dart
    - challenge_tracker/lib/features/challenges/data/models/challenge.dart

decisions:
  - key: "utc-normalization-pattern"
    choice: "DateTime.utc(year, month, day) for all date storage"
    rationale: "Ensures local dates stored as UTC midnight for consistent comparison across operations"
    alternatives: ["DateTime.now().toUtc() - incorrect, shifts time components"]

  - key: "start-date-validation"
    choice: "Add isBefore(startDate) check in toggleCompletion"
    rationale: "Prevents users from marking completions before challenge began"
    alternatives: ["UI-only prevention - not reliable, backend validation required"]

  - key: "documentation-addition"
    choice: "Add comprehensive doc comments to computed properties"
    rationale: "Makes date logic explicit for future maintainers"
    alternatives: ["Minimal comments - insufficient for complex date handling"]

metrics:
  duration: "3 minutes"
  completed: "2026-02-06"
---

# Phase 04.1 Plan 01: Fix Streak and Day Tracking Summary

**One-liner:** Established consistent `DateTime.utc(year, month, day)` normalization pattern and added start date validation to fix broken streak calculations, day counters, and duplicate prevention.

## What Was Built

Fixed critical date handling bugs causing incorrect streak counts, day counter values, and duplicate completion entries:

1. **StreakCalculator UTC normalization** - Fixed buggy `getCurrentUtcTimestamp()` method that used `DateTime.now().toUtc()` (incorrect - shifts hours). Renamed to `getTodayUtcTimestamp()` and replaced with `DateTime.utc(year, month, day)` pattern (correct - stores local date as UTC midnight).

2. **ChallengeRepository start date validation** - Added missing validation in `toggleCompletion()` to prevent completions before challenge start date. Users could previously mark dates before the challenge began.

3. **Challenge model documentation** - Added comprehensive doc comments to `completedDays`, `progress`, and `currentDay` computed properties explaining Set deduplication, inclusive day counting, and UTC normalization.

## Files Modified

```
challenge_tracker/lib/core/utils/streak_calculator.dart
  - Fixed getTodayUtcTimestamp() method (renamed from getCurrentUtcTimestamp)
  - Changed DateTime.now().toUtc() to DateTime.utc(year, month, day)
  - Method currently unused but now correctly implemented

challenge_tracker/lib/features/challenges/data/repositories/challenge_repository.dart
  - Added start date validation to toggleCompletion()
  - Now validates: before start (NEW), future dates (existing), duplicates (existing)
  - Early return pattern prevents invalid completions

challenge_tracker/lib/features/challenges/data/models/challenge.dart
  - Added doc comments to completedDays getter (Set deduplication)
  - Added doc comments to currentDay getter (inclusive counting)
  - Added doc comments to progress getter (unique days only)
  - No behavioral changes, documentation only
```

## Task Breakdown

| Task | Name | Type | Files | Result |
|------|------|------|-------|--------|
| 1 | Fix StreakCalculator UTC Normalization | auto | streak_calculator.dart | ✓ Renamed method, fixed implementation |
| 2 | Fix ChallengeRepository Duplicate Prevention | auto | challenge_repository.dart | ✓ Added start date validation |
| 3 | Verify and Document Challenge Model | auto | challenge.dart | ✓ Documentation added |

**Task commits:**
- `56af68d`: fix(04.1-01): fix StreakCalculator UTC normalization
- `9071d3f`: fix(04.1-01): add start date validation to toggleCompletion
- `53c5823`: docs(04.1-01): document Challenge model date logic

## Decisions Made

**1. UTC normalization pattern**
- **Decision:** Use `DateTime.utc(year, month, day)` for all date storage operations
- **Reasoning:** Stores local dates as UTC midnight for consistent comparison. `DateTime.now().toUtc()` incorrectly shifts time components (e.g., 11pm local becomes next day UTC).
- **Impact:** All date operations now use same normalization approach

**2. Start date validation location**
- **Decision:** Add validation to `toggleCompletion()` repository method
- **Reasoning:** Backend validation prevents invalid data regardless of UI state. UI-only prevention is unreliable.
- **Impact:** Users cannot create completions before challenge start date

**3. Documentation approach**
- **Decision:** Add comprehensive doc comments explaining date logic
- **Reasoning:** Date handling is complex (UTC storage, local comparison, inclusive counting). Future maintainers need explicit documentation.
- **Impact:** Code is now self-documenting for date operations

## Deviations from Plan

None - plan executed exactly as written.

## Technical Notes

**Date normalization pattern established:**

```dart
// CORRECT - stores local date as UTC midnight
final now = DateTime.now();
final normalizedDate = DateTime.utc(now.year, now.month, now.day);

// INCORRECT - shifts time components
final buggyDate = DateTime.now().toUtc(); // Don't use this
```

**Validation order in toggleCompletion():**
1. Start date check (isBefore) - NEW
2. Duplicate detection (component comparison) - existing
3. Future date check (isAfter) - existing

**Challenge model computed properties:**
- `completedDays`: Uses Set deduplication to handle legacy duplicates
- `currentDay`: Uses +1 for inclusive counting (start date = Day 1)
- `progress`: Based on unique completed days, not raw completion count

## Testing Completed

**Build verification:**
```
✓ flutter build ios --debug
✓ Build successful in 77.2s
✓ No compilation errors
```

**Code verification:**
- ✓ No instances of `DateTime.now().toUtc()` remain
- ✓ `getTodayUtcTimestamp()` uses correct pattern
- ✓ Three validations present in `toggleCompletion()`
- ✓ `completedDays` uses `.toSet()` deduplication
- ✓ `currentDay` uses `+ 1` inclusive counting

## Next Phase Readiness

**What's ready:**
- Date handling is now consistent across codebase
- Streak calculations will work correctly
- Day counter will show correct Day X of 30
- Calendar + Done button interactions won't create duplicates

**Blockers for 04-02 (Pre-launch Polish):**
None - date tracking is now fixed. Can proceed with:
- Offline testing
- Confetti animation
- Compliance audit
- Placeholder content removal

**Known issues:**
None introduced. This was purely a bug fix with no new functionality.

## Lessons Learned

**What went well:**
- Clear root cause identification (UTC conversion vs normalization)
- Atomic commits made each fix independently revertable
- Documentation additions clarify complex date logic

**What could improve:**
- Original implementation should have included start date validation from the start
- Date handling complexity suggests need for centralized date utility (consider for V2)

**Reusable patterns:**
- `DateTime.utc(year, month, day)` normalization pattern
- Early return validation guards
- Component-wise date comparison for duplicate detection

---

**Phase:** 04.1-fix-streak-and-day-tracking
**Plan:** 01
**Status:** Complete
**Duration:** 3 minutes
**Completed:** 2026-02-06
