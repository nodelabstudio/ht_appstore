---
phase: 01-foundation-core-flow
plan: 04
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - challenge_tracker/lib/features/challenges/presentation/screens/pack_selection_screen.dart
  - challenge_tracker/lib/features/challenges/presentation/screens/challenge_creation_screen.dart
  - challenge_tracker/lib/features/challenges/presentation/widgets/pack_card.dart
  - challenge_tracker/lib/features/challenges/presentation/screens/home_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can see 3 preset challenge packs on selection screen"
    - "User can tap a pack to proceed to challenge creation"
    - "User can set start date with date picker"
    - "User can optionally set reminder time with time picker"
    - "Tapping Create saves challenge and returns to home"
  artifacts:
    - path: "challenge_tracker/lib/features/challenges/presentation/screens/pack_selection_screen.dart"
      provides: "Pack selection screen showing 3 presets"
      contains: "ChallengePack.presets"
    - path: "challenge_tracker/lib/features/challenges/presentation/screens/challenge_creation_screen.dart"
      provides: "Challenge creation form with pickers"
      contains: "showDatePicker"
    - path: "challenge_tracker/lib/features/challenges/presentation/widgets/pack_card.dart"
      provides: "Visual pack card with emoji, name, description"
      contains: "pack.emoji"
  key_links:
    - from: "challenge_creation_screen.dart"
      to: "challengeListProvider.notifier"
      via: "createChallenge method"
      pattern: "ref\\.read\\(challengeListProvider\\.notifier\\)\\.createChallenge"
    - from: "home_screen.dart"
      to: "pack_selection_screen.dart"
      via: "Navigator.push"
      pattern: "Navigator\\.push.*PackSelectionScreen"
---

<objective>
Create the add challenge flow with pack selection and challenge creation screens.

Purpose: Enables users to create new challenges from preset packs (CHAL-02, CHAL-03, CHAL-04) - the primary way users start using the app.
Output: PackSelectionScreen showing 3 packs, ChallengeCreationScreen with date/time pickers, navigation wired from home screen.
</objective>

<execution_context>
@/Users/angelrodriguez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angelrodriguez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-flow/01-RESEARCH.md
@.planning/phases/01-foundation-core-flow/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PackCard widget and PackSelectionScreen</name>
  <files>
    challenge_tracker/lib/features/challenges/presentation/widgets/pack_card.dart
    challenge_tracker/lib/features/challenges/presentation/screens/pack_selection_screen.dart
  </files>
  <action>
1. Create pack_card.dart widget for displaying a single pack option:
```dart
import 'package:flutter/material.dart';
import '../../data/models/challenge_pack.dart';

class PackCard extends StatelessWidget {
  final ChallengePack pack;
  final VoidCallback onTap;

  const PackCard({
    super.key,
    required this.pack,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Card(
      elevation: 2,
      clipBehavior: Clip.antiAlias,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Row(
            children: [
              // Emoji
              Container(
                width: 56,
                height: 56,
                decoration: BoxDecoration(
                  color: theme.colorScheme.primaryContainer,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Center(
                  child: Text(
                    pack.emoji,
                    style: const TextStyle(fontSize: 28),
                  ),
                ),
              ),
              const SizedBox(width: 16),
              // Name and description
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      pack.name,
                      style: theme.textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      pack.description,
                      style: theme.textTheme.bodyMedium?.copyWith(
                        color: theme.colorScheme.onSurfaceVariant,
                      ),
                    ),
                  ],
                ),
              ),
              // Chevron
              Icon(
                Icons.chevron_right,
                color: theme.colorScheme.onSurfaceVariant,
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

2. Create pack_selection_screen.dart:
```dart
import 'package:flutter/material.dart';
import '../../data/models/challenge_pack.dart';
import '../widgets/pack_card.dart';
import 'challenge_creation_screen.dart';

class PackSelectionScreen extends StatelessWidget {
  const PackSelectionScreen({super.key});

  void _selectPack(BuildContext context, ChallengePack pack) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ChallengeCreationScreen(pack: pack),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Choose a Challenge'),
        centerTitle: true,
      ),
      body: ListView.separated(
        padding: const EdgeInsets.all(16),
        itemCount: ChallengePack.presets.length,
        separatorBuilder: (context, index) => const SizedBox(height: 12),
        itemBuilder: (context, index) {
          final pack = ChallengePack.presets[index];
          return PackCard(
            pack: pack,
            onTap: () => _selectPack(context, pack),
          );
        },
      ),
    );
  }
}
```

KEY: Uses ChallengePack.presets to show all 3 preset packs. Tapping navigates to ChallengeCreationScreen with selected pack.
  </action>
  <verify>
Run: `cd challenge_tracker && flutter analyze lib/features/challenges/presentation/widgets/pack_card.dart lib/features/challenges/presentation/screens/pack_selection_screen.dart`
Expected: Warning about missing ChallengeCreationScreen import (will exist after Task 2)
  </verify>
  <done>
- PackCard shows emoji, name, description with Material 3 styling
- PackSelectionScreen displays list of all 3 preset packs
- Tapping pack navigates to creation screen
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChallengeCreationScreen with date and time pickers</name>
  <files>
    challenge_tracker/lib/features/challenges/presentation/screens/challenge_creation_screen.dart
  </files>
  <action>
1. Create challenge_creation_screen.dart with form and pickers:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../data/models/challenge_pack.dart';
import '../notifiers/challenge_list_notifier.dart';
import '../../../../core/utils/date_utils.dart' as app_date_utils;

class ChallengeCreationScreen extends ConsumerStatefulWidget {
  final ChallengePack pack;

  const ChallengeCreationScreen({
    super.key,
    required this.pack,
  });

  @override
  ConsumerState<ChallengeCreationScreen> createState() =>
      _ChallengeCreationScreenState();
}

class _ChallengeCreationScreenState
    extends ConsumerState<ChallengeCreationScreen> {
  late DateTime _startDate;
  TimeOfDay? _reminderTime;
  bool _isCreating = false;

  @override
  void initState() {
    super.initState();
    _startDate = DateTime.now();
  }

  Future<void> _selectStartDate() async {
    final pickedDate = await showDatePicker(
      context: context,
      initialDate: _startDate,
      firstDate: DateTime.now(),
      lastDate: DateTime.now().add(const Duration(days: 365)),
    );

    if (pickedDate != null && pickedDate != _startDate) {
      setState(() {
        _startDate = pickedDate;
      });
    }
  }

  Future<void> _selectReminderTime() async {
    final pickedTime = await showTimePicker(
      context: context,
      initialTime: _reminderTime ?? const TimeOfDay(hour: 9, minute: 0),
    );

    if (pickedTime != null) {
      setState(() {
        _reminderTime = pickedTime;
      });
    }
  }

  void _clearReminderTime() {
    setState(() {
      _reminderTime = null;
    });
  }

  Future<void> _createChallenge() async {
    if (_isCreating) return;

    setState(() {
      _isCreating = true;
    });

    try {
      // Convert start date to UTC timestamp at midnight local time
      final startDateMidnight = DateTime(
        _startDate.year,
        _startDate.month,
        _startDate.day,
      );
      final startDateUtc =
          startDateMidnight.toUtc().millisecondsSinceEpoch ~/ 1000;

      // Convert reminder time to minutes since midnight
      final reminderTimeMinutes = _reminderTime != null
          ? app_date_utils.DateUtils.timeOfDayToMinutes(_reminderTime!)
          : null;

      await ref.read(challengeListProvider.notifier).createChallenge(
            pack: widget.pack,
            startDateUtc: startDateUtc,
            reminderTimeMinutes: reminderTimeMinutes,
          );

      if (mounted) {
        // Pop back to home screen (pop twice: creation -> selection -> home)
        Navigator.of(context).popUntil((route) => route.isFirst);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to create challenge: $e')),
        );
        setState(() {
          _isCreating = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final dateFormat = DateFormat.yMMMd();

    return Scaffold(
      appBar: AppBar(
        title: const Text('Create Challenge'),
        centerTitle: true,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Pack info card
            Card(
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Row(
                  children: [
                    Container(
                      width: 48,
                      height: 48,
                      decoration: BoxDecoration(
                        color: theme.colorScheme.primaryContainer,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Center(
                        child: Text(
                          widget.pack.emoji,
                          style: const TextStyle(fontSize: 24),
                        ),
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            widget.pack.name,
                            style: theme.textTheme.titleMedium?.copyWith(
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          Text(
                            widget.pack.description,
                            style: theme.textTheme.bodySmall?.copyWith(
                              color: theme.colorScheme.onSurfaceVariant,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
            const SizedBox(height: 24),

            // Start Date
            Text(
              'Start Date',
              style: theme.textTheme.titleSmall?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            Card(
              child: ListTile(
                leading: const Icon(Icons.calendar_today),
                title: Text(dateFormat.format(_startDate)),
                trailing: const Icon(Icons.chevron_right),
                onTap: _selectStartDate,
              ),
            ),
            const SizedBox(height: 24),

            // Reminder Time (optional)
            Text(
              'Daily Reminder (Optional)',
              style: theme.textTheme.titleSmall?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            Card(
              child: ListTile(
                leading: const Icon(Icons.notifications_outlined),
                title: Text(
                  _reminderTime != null
                      ? _reminderTime!.format(context)
                      : 'No reminder set',
                ),
                trailing: _reminderTime != null
                    ? IconButton(
                        icon: const Icon(Icons.clear),
                        onPressed: _clearReminderTime,
                      )
                    : const Icon(Icons.chevron_right),
                onTap: _selectReminderTime,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Get reminded daily to complete your challenge',
              style: theme.textTheme.bodySmall?.copyWith(
                color: theme.colorScheme.onSurfaceVariant,
              ),
            ),
            const SizedBox(height: 32),

            // Create button
            SizedBox(
              width: double.infinity,
              child: FilledButton(
                onPressed: _isCreating ? null : _createChallenge,
                style: FilledButton.styleFrom(
                  padding: const EdgeInsets.symmetric(vertical: 16),
                ),
                child: _isCreating
                    ? const SizedBox(
                        height: 20,
                        width: 20,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          color: Colors.white,
                        ),
                      )
                    : const Text('Start Challenge'),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

KEY PATTERNS:
- Uses showDatePicker for start date (default: today, can pick future dates)
- Uses showTimePicker for optional reminder time
- Converts dates to UTC timestamps for storage
- Converts TimeOfDay to minutes since midnight
- Calls challengeListProvider.notifier.createChallenge()
- Pops back to home screen on success
  </action>
  <verify>
Run: `cd challenge_tracker && flutter analyze lib/features/challenges/presentation/screens/challenge_creation_screen.dart`
Expected: No errors
  </verify>
  <done>
- ChallengeCreationScreen shows selected pack info
- Date picker for start date (today or future)
- Time picker for optional reminder
- "Start Challenge" button creates and saves challenge
- Returns to home screen on success
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire navigation from HomeScreen to PackSelectionScreen</name>
  <files>
    challenge_tracker/lib/features/challenges/presentation/screens/home_screen.dart
  </files>
  <action>
1. Update home_screen.dart to navigate to PackSelectionScreen:

Replace the TODO comment in _navigateToAddChallenge method:
```dart
import 'pack_selection_screen.dart';

// Update the method:
void _navigateToAddChallenge(BuildContext context) {
  Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => const PackSelectionScreen(),
    ),
  );
}
```

2. Full updated home_screen.dart (showing import and method changes):
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../notifiers/challenge_list_notifier.dart';
import '../widgets/challenge_grid_item.dart';
import '../widgets/empty_state_view.dart';
import 'pack_selection_screen.dart';

class HomeScreen extends ConsumerWidget {
  const HomeScreen({super.key});

  void _navigateToAddChallenge(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const PackSelectionScreen(),
      ),
    );
  }

  void _navigateToChallengeDetail(BuildContext context, String challengeId) {
    // TODO: Navigate to challenge detail screen (Plan 05)
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Challenge detail: $challengeId')),
    );
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // ... rest unchanged
  }
}
```

3. Test the full flow:
- Run app
- Tap "Add Challenge" on empty state
- See 3 pack options
- Select one, configure date/time
- Tap "Start Challenge"
- Return to home, see new challenge in grid
  </action>
  <verify>
Run: `cd challenge_tracker && flutter analyze && flutter run -d macos`
Expected: Full add challenge flow works - can create challenges from any of the 3 packs
  </verify>
  <done>
- Home screen "Add Challenge" button navigates to PackSelectionScreen
- Full flow works: Home -> Pack Selection -> Creation Form -> Home (with new challenge)
- Empty state and FAB both use same navigation
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` - no errors
2. `flutter run` - app launches
3. Tap "Add Challenge" from empty state - navigates to pack selection
4. See all 3 preset packs with emoji, name, description
5. Tap a pack - navigates to creation screen showing selected pack
6. Date picker opens and allows selecting today or future dates
7. Time picker opens and allows setting reminder (optional)
8. "Start Challenge" creates challenge and returns to home
9. New challenge appears in grid on home screen
</verification>

<success_criteria>
- PackSelectionScreen shows all 3 preset packs from ChallengePack.presets
- PackCard displays emoji, name, description with proper styling
- ChallengeCreationScreen has working date picker (today minimum)
- ChallengeCreationScreen has optional time picker for reminders
- Create button calls challengeListProvider.notifier.createChallenge()
- Navigation returns to home screen after creation
- New challenge visible in home screen grid
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-flow/01-04-SUMMARY.md`
</output>
