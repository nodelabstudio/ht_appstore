---
phase: 01-foundation-core-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - challenge_tracker/pubspec.yaml
  - challenge_tracker/lib/main.dart
  - challenge_tracker/lib/features/challenges/data/models/challenge.dart
  - challenge_tracker/lib/features/challenges/data/models/challenge_pack.dart
  - challenge_tracker/lib/features/challenges/data/services/hive_service.dart
  - challenge_tracker/lib/core/utils/streak_calculator.dart
  - challenge_tracker/lib/core/utils/date_utils.dart
autonomous: true

must_haves:
  truths:
    - "Flutter project builds without errors"
    - "Hive initializes on app start"
    - "Timezone database loads on app start"
    - "Challenge model can be serialized to Hive"
    - "Streak calculation returns correct count for sample data"
  artifacts:
    - path: "challenge_tracker/pubspec.yaml"
      provides: "Project dependencies"
      contains: "hive:"
    - path: "challenge_tracker/lib/main.dart"
      provides: "App entry point with Hive/timezone init"
      contains: "Hive.initFlutter"
    - path: "challenge_tracker/lib/features/challenges/data/models/challenge.dart"
      provides: "Challenge domain model with HiveType"
      contains: "@HiveType"
    - path: "challenge_tracker/lib/features/challenges/data/models/challenge_pack.dart"
      provides: "ChallengePack with 3 preset packs"
      contains: "noSugar30"
    - path: "challenge_tracker/lib/features/challenges/data/services/hive_service.dart"
      provides: "Hive box management wrapper"
      contains: "openBox"
    - path: "challenge_tracker/lib/core/utils/streak_calculator.dart"
      provides: "Timezone-safe streak calculation"
      contains: "TZDateTime"
  key_links:
    - from: "challenge_tracker/lib/main.dart"
      to: "Hive.initFlutter"
      via: "initialization"
      pattern: "await Hive\\.initFlutter"
    - from: "challenge_tracker/lib/features/challenges/data/models/challenge.dart"
      to: "streak_calculator.dart"
      via: "computed property"
      pattern: "StreakCalculator\\.calculateStreak"
---

<objective>
Set up Flutter project with Hive persistence, timezone support, and core domain models.

Purpose: Establishes the foundation that all other plans depend on - data layer, persistence, and timezone-safe streak logic.
Output: Working Flutter project with Challenge/ChallengePack models, HiveService wrapper, and StreakCalculator utility.
</objective>

<execution_context>
@/Users/angelrodriguez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angelrodriguez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-core-flow/01-RESEARCH.md
@assets/flutter-template/pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Flutter project and configure dependencies</name>
  <files>
    challenge_tracker/pubspec.yaml
    challenge_tracker/lib/main.dart
  </files>
  <action>
1. Create new Flutter project named `challenge_tracker` from template:
   - Copy assets/flutter-template/ to challenge_tracker/
   - Rename package from flutter_template to challenge_tracker in all files

2. Update pubspec.yaml with Phase 1 dependencies (from RESEARCH.md Standard Stack):
```yaml
dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.8
  hive: ^2.2.3
  hive_flutter: ^1.1.0
  flutter_riverpod: ^2.6.1
  riverpod_annotation: ^2.6.1
  timezone: ^0.11.0
  intl: ^0.20.2
  percent_indicator: ^4.2.5
  uuid: ^4.5.2

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^6.0.0
  hive_generator: ^2.0.1
  riverpod_generator: ^2.6.2
  build_runner: ^2.4.15
```

3. Create main.dart with initialization:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'package:timezone/data/latest.dart' as tz;

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Hive
  await Hive.initFlutter();

  // Initialize timezone database
  tz.initializeTimeZones();

  runApp(
    const ProviderScope(
      child: ChallengeTrackerApp(),
    ),
  );
}

class ChallengeTrackerApp extends StatelessWidget {
  const ChallengeTrackerApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: '30-Day Challenge',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
        useMaterial3: true,
      ),
      home: const Scaffold(
        body: Center(child: Text('Challenge Tracker')),
      ),
    );
  }
}
```

4. Run `flutter pub get` in challenge_tracker directory.
  </action>
  <verify>
Run: `cd challenge_tracker && flutter pub get && flutter analyze`
Expected: No errors, all dependencies resolve
  </verify>
  <done>Flutter project exists at challenge_tracker/, pubspec.yaml has all required deps, flutter analyze passes</done>
</task>

<task type="auto">
  <name>Task 2: Create Challenge and ChallengePack models with Hive annotations</name>
  <files>
    challenge_tracker/lib/features/challenges/data/models/challenge.dart
    challenge_tracker/lib/features/challenges/data/models/challenge_pack.dart
  </files>
  <action>
1. Create directory structure: lib/features/challenges/data/models/

2. Create challenge.dart with Hive annotations:
```dart
import 'package:hive/hive.dart';

part 'challenge.g.dart';

@HiveType(typeId: 0)
class Challenge extends HiveObject {
  @HiveField(0)
  final String id;

  @HiveField(1)
  final String name;

  @HiveField(2)
  final String packId;

  @HiveField(3)
  final int startDateUtc; // Unix timestamp in seconds

  @HiveField(4)
  final List<int> completionDatesUtc; // List of UTC timestamps (Hive doesn't support Set)

  @HiveField(5)
  final int? reminderTimeMinutes; // Minutes since midnight (null = no reminder)

  @HiveField(6)
  final bool isStreakFrozen; // Forgiveness feature - freeze streak for today

  Challenge({
    required this.id,
    required this.name,
    required this.packId,
    required this.startDateUtc,
    List<int>? completionDatesUtc,
    this.reminderTimeMinutes,
    this.isStreakFrozen = false,
  }) : completionDatesUtc = completionDatesUtc ?? [];

  // Immutable copy helper
  Challenge copyWith({
    String? id,
    String? name,
    String? packId,
    int? startDateUtc,
    List<int>? completionDatesUtc,
    int? reminderTimeMinutes,
    bool? isStreakFrozen,
  }) {
    return Challenge(
      id: id ?? this.id,
      name: name ?? this.name,
      packId: packId ?? this.packId,
      startDateUtc: startDateUtc ?? this.startDateUtc,
      completionDatesUtc: completionDatesUtc ?? List.from(this.completionDatesUtc),
      reminderTimeMinutes: reminderTimeMinutes ?? this.reminderTimeMinutes,
      isStreakFrozen: isStreakFrozen ?? this.isStreakFrozen,
    );
  }

  // Computed: number of completions
  int get completedDays => completionDatesUtc.length;

  // Computed: progress as fraction (0.0 to 1.0)
  double get progress => completedDays / 30.0;

  // Computed: day number (1-30)
  int get currentDay => completedDays + 1;
}
```

3. Create challenge_pack.dart with 3 preset packs:
```dart
class ChallengePack {
  final String id;
  final String name;
  final String description;
  final String emoji;

  const ChallengePack({
    required this.id,
    required this.name,
    required this.description,
    required this.emoji,
  });

  // V1 Preset Packs
  static const noSugar30 = ChallengePack(
    id: 'no_sugar_30',
    name: 'No Sugar 30',
    description: '30 days without added sugar',
    emoji: 'üç¨',
  );

  static const dailyWalk30 = ChallengePack(
    id: 'daily_walk_30',
    name: 'Daily Walk 30',
    description: '30 days of daily walks',
    emoji: 'üö∂',
  );

  static const read10Pages30 = ChallengePack(
    id: 'read_10_pages_30',
    name: 'Read 10 Pages 30',
    description: '30 days of reading 10 pages',
    emoji: 'üìö',
  );

  static const List<ChallengePack> presets = [
    noSugar30,
    dailyWalk30,
    read10Pages30,
  ];

  static ChallengePack? getById(String id) {
    try {
      return presets.firstWhere((pack) => pack.id == id);
    } catch (_) {
      return null;
    }
  }
}
```

NOTE: Using List<int> instead of Set<int> for completionDatesUtc because Hive's TypeAdapter doesn't natively support Set. Convert to Set in business logic when needed.
  </action>
  <verify>
Run: `cd challenge_tracker && flutter analyze lib/features/challenges/data/models/`
Expected: Only warning about missing .g.dart file (expected until build_runner runs)
  </verify>
  <done>Challenge model has @HiveType with 7 fields, ChallengePack has 3 preset packs, copyWith helper exists</done>
</task>

<task type="auto">
  <name>Task 3: Create HiveService wrapper and StreakCalculator utility</name>
  <files>
    challenge_tracker/lib/features/challenges/data/services/hive_service.dart
    challenge_tracker/lib/core/utils/streak_calculator.dart
    challenge_tracker/lib/core/utils/date_utils.dart
  </files>
  <action>
1. Create directory structure: lib/features/challenges/data/services/ and lib/core/utils/

2. Create hive_service.dart with explicit box management (from RESEARCH.md Pattern 2):
```dart
import 'package:hive_flutter/hive_flutter.dart';
import '../models/challenge.dart';

class HiveService {
  static const String challengesBoxName = 'challenges';

  bool _isInitialized = false;

  Future<void> init() async {
    if (_isInitialized) return;

    // Register adapter (generated by build_runner)
    if (!Hive.isAdapterRegistered(0)) {
      Hive.registerAdapter(ChallengeAdapter());
    }

    _isInitialized = true;
  }

  Future<Box<Challenge>> _openBox() async {
    await init();
    if (Hive.isBoxOpen(challengesBoxName)) {
      return Hive.box<Challenge>(challengesBoxName);
    }
    return await Hive.openBox<Challenge>(challengesBoxName);
  }

  Future<List<Challenge>> getAllChallenges() async {
    final box = await _openBox();
    return box.values.toList();
  }

  Future<Challenge?> getChallenge(String id) async {
    final box = await _openBox();
    return box.get(id);
  }

  Future<void> saveChallenge(Challenge challenge) async {
    final box = await _openBox();
    await box.put(challenge.id, challenge);
  }

  Future<void> deleteChallenge(String id) async {
    final box = await _openBox();
    await box.delete(id);
  }

  Future<void> closeBox() async {
    if (Hive.isBoxOpen(challengesBoxName)) {
      await Hive.box<Challenge>(challengesBoxName).close();
    }
  }
}
```

3. Create streak_calculator.dart with timezone-safe logic (from RESEARCH.md Pattern 4):
```dart
import 'package:timezone/timezone.dart' as tz;

class StreakCalculator {
  /// Calculate current streak from UTC timestamps
  /// Handles timezone changes and DST transitions
  static int calculateStreak(List<int> completionTimestampsUtc, int startDateUtc) {
    if (completionTimestampsUtc.isEmpty) return 0;

    final location = tz.local;
    final now = tz.TZDateTime.now(location);
    final todayDate = _stripTime(now);

    // Convert UTC timestamps to local dates (as unique set)
    final completionDates = completionTimestampsUtc
        .map((utc) => _utcTimestampToLocalDate(utc, location))
        .toSet();

    // Grace period: check completion today or yesterday
    final yesterdayDate = todayDate.subtract(const Duration(days: 1));

    // If not completed today AND not completed yesterday, streak is broken
    if (!completionDates.contains(todayDate) &&
        !completionDates.contains(yesterdayDate)) {
      return 0;
    }

    // Count consecutive days backwards from most recent completion
    int streak = 0;
    var checkDate = completionDates.contains(todayDate) ? todayDate : yesterdayDate;

    final startDate = _utcTimestampToLocalDate(startDateUtc, location);

    while (completionDates.contains(checkDate) && !checkDate.isBefore(startDate)) {
      streak++;
      checkDate = checkDate.subtract(const Duration(days: 1));
    }

    return streak;
  }

  /// Check if challenge completed today in user's timezone
  static bool isCompletedToday(List<int> completionTimestampsUtc) {
    if (completionTimestampsUtc.isEmpty) return false;

    final location = tz.local;
    final now = tz.TZDateTime.now(location);
    final todayDate = _stripTime(now);

    return completionTimestampsUtc.any((utc) {
      final completionDate = _utcTimestampToLocalDate(utc, location);
      return completionDate == todayDate;
    });
  }

  /// Get today's completion timestamp if exists, null otherwise
  static int? getTodayCompletionTimestamp(List<int> completionTimestampsUtc) {
    if (completionTimestampsUtc.isEmpty) return null;

    final location = tz.local;
    final now = tz.TZDateTime.now(location);
    final todayDate = _stripTime(now);

    for (final utc in completionTimestampsUtc) {
      final completionDate = _utcTimestampToLocalDate(utc, location);
      if (completionDate == todayDate) {
        return utc;
      }
    }
    return null;
  }

  /// Store current completion as UTC timestamp (seconds)
  static int getCurrentUtcTimestamp() {
    return DateTime.now().toUtc().millisecondsSinceEpoch ~/ 1000;
  }

  /// Convert UTC timestamp to local date (stripped of time)
  static tz.TZDateTime _utcTimestampToLocalDate(int utcTimestamp, tz.Location location) {
    final utcDateTime = DateTime.fromMillisecondsSinceEpoch(utcTimestamp * 1000, isUtc: true);
    final localDateTime = tz.TZDateTime.from(utcDateTime, location);
    return _stripTime(localDateTime);
  }

  /// Strip time component, return date-only
  static tz.TZDateTime _stripTime(tz.TZDateTime dateTime) {
    return tz.TZDateTime(
      dateTime.location,
      dateTime.year,
      dateTime.month,
      dateTime.day,
    );
  }
}
```

4. Create date_utils.dart for display formatting:
```dart
import 'package:intl/intl.dart';
import 'package:timezone/timezone.dart' as tz;

class DateUtils {
  /// Format UTC timestamp as local date string
  static String formatDate(int utcTimestamp) {
    final utcDateTime = DateTime.fromMillisecondsSinceEpoch(utcTimestamp * 1000, isUtc: true);
    final localDateTime = utcDateTime.toLocal();
    return DateFormat.yMMMd().format(localDateTime);
  }

  /// Format reminder time (minutes since midnight) as HH:MM
  static String formatReminderTime(int minutesSinceMidnight) {
    final hours = minutesSinceMidnight ~/ 60;
    final minutes = minutesSinceMidnight % 60;
    final time = TimeOfDay(hour: hours, minute: minutes);

    // Format as 12-hour with AM/PM
    final now = DateTime.now();
    final dt = DateTime(now.year, now.month, now.day, time.hour, time.minute);
    return DateFormat.jm().format(dt);
  }

  /// Convert TimeOfDay to minutes since midnight
  static int timeOfDayToMinutes(TimeOfDay time) {
    return time.hour * 60 + time.minute;
  }

  /// Get current date as UTC timestamp at midnight
  static int getTodayUtcTimestamp() {
    final now = DateTime.now();
    final todayMidnight = DateTime(now.year, now.month, now.day);
    return todayMidnight.toUtc().millisecondsSinceEpoch ~/ 1000;
  }
}

// Re-export TimeOfDay for convenience
export 'package:flutter/material.dart' show TimeOfDay;
```

5. Update main.dart to initialize HiveService:
```dart
// Add import
import 'features/challenges/data/services/hive_service.dart';

// Update main() to call HiveService.init()
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Hive
  await Hive.initFlutter();

  // Initialize timezone database
  tz.initializeTimeZones();

  // Initialize HiveService (registers adapters)
  final hiveService = HiveService();
  await hiveService.init();

  runApp(
    const ProviderScope(
      child: ChallengeTrackerApp(),
    ),
  );
}
```

6. Run build_runner to generate Hive adapter:
```bash
cd challenge_tracker && flutter pub run build_runner build --delete-conflicting-outputs
```
  </action>
  <verify>
Run: `cd challenge_tracker && flutter pub run build_runner build --delete-conflicting-outputs && flutter analyze`
Expected: challenge.g.dart generated, no analysis errors
  </verify>
  <done>
- HiveService exists with init/getAllChallenges/saveChallenge/deleteChallenge
- StreakCalculator has calculateStreak and isCompletedToday methods using TZDateTime
- challenge.g.dart generated by build_runner
- App builds and runs without errors
  </done>
</task>

</tasks>

<verification>
1. `cd challenge_tracker && flutter pub get` - all dependencies resolve
2. `flutter pub run build_runner build --delete-conflicting-outputs` - generates .g.dart files
3. `flutter analyze` - no errors
4. `flutter run` - app launches showing placeholder text
5. Verify file structure matches RESEARCH.md recommended structure
</verification>

<success_criteria>
- Flutter project at challenge_tracker/ with all Phase 1 dependencies
- Challenge model with @HiveType annotation and 7 fields
- ChallengePack with 3 preset packs (noSugar30, dailyWalk30, read10Pages30)
- HiveService wrapper with explicit box management
- StreakCalculator with timezone-safe streak calculation using TZDateTime
- Generated challenge.g.dart exists and compiles
- `flutter analyze` passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-flow/01-01-SUMMARY.md`
</output>
