---
phase: 01-foundation-core-flow
plan: 05
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - challenge_tracker/lib/features/challenges/presentation/screens/challenge_detail_screen.dart
  - challenge_tracker/lib/features/challenges/presentation/screens/home_screen.dart
autonomous: true

must_haves:
  truths:
    - "User can view challenge detail showing name, streak, progress ring, Day X/30"
    - "User can tap Done button to mark challenge complete for today"
    - "User can tap Undo button to undo same-day completion"
    - "Undo button only visible if completed today"
    - "Tapping challenge tile on home screen opens detail screen"
  artifacts:
    - path: "challenge_tracker/lib/features/challenges/presentation/screens/challenge_detail_screen.dart"
      provides: "Challenge detail screen with Done and Undo buttons"
      contains: "markComplete"
  key_links:
    - from: "challenge_detail_screen.dart"
      to: "challengeListProvider.notifier"
      via: "markComplete method"
      pattern: "ref\\.read\\(challengeListProvider\\.notifier\\)\\.markComplete"
    - from: "challenge_detail_screen.dart"
      to: "challengeListProvider.notifier"
      via: "undoTodayCompletion method"
      pattern: "ref\\.read\\(challengeListProvider\\.notifier\\)\\.undoTodayCompletion"
    - from: "home_screen.dart"
      to: "challenge_detail_screen.dart"
      via: "Navigator.push"
      pattern: "Navigator\\.push.*ChallengeDetailScreen"
---

<objective>
Create the challenge detail screen with Done button for completion and Undo button for same-day corrections.

Purpose: The detail screen is where users complete their daily challenge (CHAL-05, COMP-01, COMP-03) - the primary interaction that maintains streaks.
Output: ChallengeDetailScreen showing progress, streak, and completion controls; navigation wired from home screen.
</objective>

<execution_context>
@/Users/angelrodriguez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/angelrodriguez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-flow/01-RESEARCH.md
@.planning/phases/01-foundation-core-flow/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChallengeDetailScreen with progress display</name>
  <files>
    challenge_tracker/lib/features/challenges/presentation/screens/challenge_detail_screen.dart
  </files>
  <action>
1. Create challenge_detail_screen.dart:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../data/models/challenge.dart';
import '../../data/models/challenge_pack.dart';
import '../notifiers/challenge_list_notifier.dart';
import '../widgets/progress_ring.dart';
import '../../../../core/utils/streak_calculator.dart';
import '../../../../core/utils/date_utils.dart' as app_date_utils;

class ChallengeDetailScreen extends ConsumerWidget {
  final String challengeId;

  const ChallengeDetailScreen({
    super.key,
    required this.challengeId,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final challenge = ref.watch(challengeByIdProvider(challengeId));

    if (challenge == null) {
      return Scaffold(
        appBar: AppBar(
          title: const Text('Challenge'),
        ),
        body: const Center(
          child: Text('Challenge not found'),
        ),
      );
    }

    return _ChallengeDetailContent(challenge: challenge);
  }
}

class _ChallengeDetailContent extends ConsumerWidget {
  final Challenge challenge;

  const _ChallengeDetailContent({required this.challenge});

  Future<void> _markComplete(BuildContext context, WidgetRef ref) async {
    try {
      await ref.read(challengeListProvider.notifier).markComplete(challenge.id);
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Challenge completed!'),
            duration: Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to complete: $e')),
        );
      }
    }
  }

  Future<void> _undoCompletion(BuildContext context, WidgetRef ref) async {
    try {
      await ref
          .read(challengeListProvider.notifier)
          .undoTodayCompletion(challenge.id);
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Completion undone'),
            duration: Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to undo: $e')),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final theme = Theme.of(context);
    final pack = ChallengePack.getById(challenge.packId);

    final isCompletedToday = StreakCalculator.isCompletedToday(
      challenge.completionDatesUtc,
    );
    final streak = StreakCalculator.calculateStreak(
      challenge.completionDatesUtc,
      challenge.startDateUtc,
    );

    return Scaffold(
      appBar: AppBar(
        title: Text(challenge.name),
        centerTitle: true,
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            children: [
              const Spacer(),

              // Pack emoji
              if (pack != null)
                Container(
                  width: 80,
                  height: 80,
                  decoration: BoxDecoration(
                    color: theme.colorScheme.primaryContainer,
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Center(
                    child: Text(
                      pack.emoji,
                      style: const TextStyle(fontSize: 40),
                    ),
                  ),
                ),
              const SizedBox(height: 24),

              // Large progress ring
              ProgressRing(
                progress: challenge.progress,
                size: 200,
                centerText: '${challenge.completedDays}/30',
                centerTextStyle: TextStyle(
                  fontSize: 32,
                  fontWeight: FontWeight.bold,
                  color: theme.colorScheme.onSurface,
                ),
                progressColor: isCompletedToday
                    ? theme.colorScheme.primary
                    : theme.colorScheme.secondary,
              ),
              const SizedBox(height: 24),

              // Day X of 30
              Text(
                'Day ${challenge.currentDay} of 30',
                style: theme.textTheme.headlineSmall?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 8),

              // Streak count
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.local_fire_department,
                    color: streak > 0 ? Colors.orange : theme.colorScheme.outline,
                    size: 24,
                  ),
                  const SizedBox(width: 8),
                  Text(
                    '$streak day streak',
                    style: theme.textTheme.titleMedium?.copyWith(
                      color: theme.colorScheme.onSurfaceVariant,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 8),

              // Start date
              Text(
                'Started ${app_date_utils.DateUtils.formatDate(challenge.startDateUtc)}',
                style: theme.textTheme.bodyMedium?.copyWith(
                  color: theme.colorScheme.onSurfaceVariant,
                ),
              ),

              const Spacer(),

              // Done button (primary action)
              if (!isCompletedToday)
                SizedBox(
                  width: double.infinity,
                  child: FilledButton(
                    onPressed: () => _markComplete(context, ref),
                    style: FilledButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 20),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                    ),
                    child: const Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.check, size: 28),
                        SizedBox(width: 12),
                        Text(
                          'Done',
                          style: TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),

              // Completed state with Undo option
              if (isCompletedToday) ...[
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.symmetric(vertical: 20),
                  decoration: BoxDecoration(
                    color: theme.colorScheme.primaryContainer,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.check_circle,
                        size: 28,
                        color: theme.colorScheme.primary,
                      ),
                      const SizedBox(width: 12),
                      Text(
                        'Completed Today!',
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          color: theme.colorScheme.onPrimaryContainer,
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 12),
                // Undo button
                TextButton(
                  onPressed: () => _undoCompletion(context, ref),
                  child: Text(
                    'Undo completion',
                    style: TextStyle(
                      color: theme.colorScheme.error,
                    ),
                  ),
                ),
              ],

              const SizedBox(height: 24),
            ],
          ),
        ),
      ),
    );
  }
}
```

KEY DESIGN DECISIONS:
- Uses challengeByIdProvider for reactive updates
- Large progress ring (200px) as focal point showing X/30
- "Day X of 30" text below ring
- Fire emoji + streak count
- Start date display
- Done button is large, prominent, one-tap target (COMP-01 requirement)
- Completed state shows checkmark with "Completed Today!" text
- Undo button only appears after completion (COMP-03 requirement)
- Undo button styled as secondary action (text button, error color)
  </action>
  <verify>
Run: `cd challenge_tracker && flutter analyze lib/features/challenges/presentation/screens/challenge_detail_screen.dart`
Expected: No errors
  </verify>
  <done>
- ChallengeDetailScreen shows pack emoji, large progress ring, Day X/30, streak count
- Done button calls markComplete() and shows success feedback
- After completion, shows "Completed Today!" state with Undo button
- Undo button calls undoTodayCompletion() (only visible if completed today)
- Screen reacts to state changes via challengeByIdProvider
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire navigation from HomeScreen to ChallengeDetailScreen</name>
  <files>
    challenge_tracker/lib/features/challenges/presentation/screens/home_screen.dart
  </files>
  <action>
1. Update home_screen.dart to navigate to ChallengeDetailScreen:

Replace the TODO comment in _navigateToChallengeDetail method:
```dart
import 'challenge_detail_screen.dart';

// Update the method:
void _navigateToChallengeDetail(BuildContext context, String challengeId) {
  Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => ChallengeDetailScreen(challengeId: challengeId),
    ),
  );
}
```

2. Full updated imports and method (add to existing home_screen.dart):
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../notifiers/challenge_list_notifier.dart';
import '../widgets/challenge_grid_item.dart';
import '../widgets/empty_state_view.dart';
import 'pack_selection_screen.dart';
import 'challenge_detail_screen.dart';

class HomeScreen extends ConsumerWidget {
  const HomeScreen({super.key});

  void _navigateToAddChallenge(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const PackSelectionScreen(),
      ),
    );
  }

  void _navigateToChallengeDetail(BuildContext context, String challengeId) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ChallengeDetailScreen(challengeId: challengeId),
      ),
    );
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // ... rest unchanged
  }
}
```

3. Test the complete flow:
- Create a challenge via Pack Selection -> Creation
- Tap the challenge tile on home screen
- See detail screen with progress ring, streak, Day X/30
- Tap "Done" button
- See "Completed Today!" state with Undo option
- Tap "Undo completion"
- See "Done" button return
- Go back to home, see tile updated (completed indicator)
  </action>
  <verify>
Run: `cd challenge_tracker && flutter analyze && flutter run -d macos`
Expected: Full completion flow works - can mark complete and undo from detail screen
  </verify>
  <done>
- Tapping challenge tile navigates to ChallengeDetailScreen
- Detail screen shows all challenge info and completion controls
- Mark complete updates both detail screen and home screen grid tile
- Undo reverts completion state
- Navigation works in both directions
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` - no errors
2. `flutter run` - app launches
3. Create a challenge (via Plan 04 flow)
4. Tap challenge tile on home screen - opens detail screen
5. Detail shows: pack emoji, progress ring with X/30, "Day X of 30", streak count, start date
6. Tap "Done" button - button transforms to "Completed Today!" state
7. Undo button appears below completed state
8. Tap "Undo completion" - reverts to showing "Done" button
9. Go back to home - tile shows updated completion status (border, check icon)
10. Return to detail - state persisted correctly
</verification>

<success_criteria>
- ChallengeDetailScreen accessible by tapping challenge tile on home
- Detail shows: name, pack emoji, large progress ring, Day X/30, streak count, start date
- Done button is prominent, easy to tap, marks challenge complete
- After completion: shows "Completed Today!" badge with Undo button
- Undo button only visible if completed today (COMP-03)
- State changes reflect immediately on both detail and home screens
- Complete flow: tap tile -> see detail -> tap Done -> see completed state -> undo works
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-flow/01-05-SUMMARY.md`
</output>
